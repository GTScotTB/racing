<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical Check - {{ event.location }} (Round {{ event.round_number }})</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .check-header {
            margin-bottom: 20px;
        }
        .competitor-table {
            margin-top: 20px;
        }
        .status-select {
            min-width: 100px;
        }
        .notes-field {
            width: 100%;
        }
        .result-column {
            min-width: 150px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center">Technical Check - {{ event.location }} (Round {{ event.round_number }})</h1>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <div class="row check-header">
            <div class="col-md-6">
                <form id="check-type-form" method="GET" class="d-flex align-items-center">
                    <label for="check-type" class="form-label me-2">Check Type:</label>
                    <select id="check-type" name="check_type" class="form-select me-2" onchange="this.form.submit()">
                        <option value="weight" {% if check_type == 'weight' %}selected{% endif %}>Weight Check</option>
                        <option value="height" {% if check_type == 'height' %}selected{% endif %}>Height Check</option>
                        <option value="fuel" {% if check_type == 'fuel' %}selected{% endif %}>Fuel Check</option>
                        <option value="track_width" {% if check_type == 'track_width' %}selected{% endif %}>Track Width</option>
                        <option value="tyre" {% if check_type == 'tyre' %}selected{% endif %}>Tyre Check</option>
                        <option value="throttle_size" {% if check_type == 'throttle_size' %}selected{% endif %}>Throttle Size</option>
                        <option value="ecu" {% if check_type == 'ecu' %}selected{% endif %}>ECU Check</option>
                        <option value="engine" {% if check_type == 'engine' %}selected{% endif %}>Engine Check</option>
                        <option value="map_sensor" {% if check_type == 'map_sensor' %}selected{% endif %}>MAP Sensor</option>
                        <option value="air_temp_sensor" {% if check_type == 'air_temp_sensor' %}selected{% endif %}>Air Temp Sensor</option>
                        <option value="lsd" {% if check_type == 'lsd' %}selected{% endif %}>LSD Check</option>
                        <option value="transponder" {% if check_type == 'transponder' %}selected{% endif %}>Transponder</option>
                        <option value="dash_data" {% if check_type == 'dash_data' %}selected{% endif %}>Dash Data</option>
                        <option value="first_gear" {% if check_type == 'first_gear' %}selected{% endif %}>First Gear</option>
                        <option value="flywheel" {% if check_type == 'flywheel' %}selected{% endif %}>Flywheel</option>
                        <option value="other" {% if check_type == 'other' %}selected{% endif %}>Other Check</option>
                    </select>
                </form>
            </div>
            <div class="col-md-6 text-end">
                <a href="{{ url_for('formula_ford_round' + event.round_number|string) }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Technical Checks
                </a>
            </div>
        </div>
        
        <div class="competitor-table">
            <h3>{{ check_type|replace('_', ' ')|title }} Results</h3>
            <form id="batch-save-form" method="POST" action="{{ url_for('save_all_technical_checks', event_id=event.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="check_type" value="{{ check_type }}">
                
                {% if check_type == 'other' %}
                <div class="mb-3 row">
                    <div class="col-md-6">
                        <label for="other-check-name" class="form-label">Check Name:</label>
                        <div class="input-group">
                            <input type="text" id="other-check-name" name="other_check_name" class="form-control" value="{{ other_check_name or '' }}" required>
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                Previous Checks
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" id="previous-checks-dropdown">
                                <li><a class="dropdown-item" href="#">Loading...</a></li>
                            </ul>
                        </div>
                        <small class="text-muted">Enter check name or select from previous checks</small>
                    </div>
                </div>
                {% endif %}
                
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Car #</th>
                            <th>Weekend #</th>
                            <th>Competitor</th>
                            {% if check_type == 'weight' %}
                                <th class="result-column">Weight (kg)</th>
                            {% elif check_type == 'ecu' %}
                                <th class="result-column">ECU Number</th>
                                <th class="result-column">ECU Tune</th>
                            {% elif check_type == 'engine' %}
                                <th class="result-column">Engine Number</th>
                            {% elif check_type == 'other' %}
                                <th class="result-column">Result</th>
                            {% else %}
                                <th class="result-column">Status</th>
                            {% endif %}
                            <th>Notes</th>
                            <th>Individual Save</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in entries %}
                        <tr>
                            <td>{{ entry.competitor.car_number }}</td>
                            <td>{{ entry.weekend_car_number if entry.weekend_car_number else "-" }}</td>
                            <td>{{ entry.competitor.first_name }} {{ entry.competitor.last_name }}</td>
                            
                            {% if check_type == 'weight' %}
                                <td><input type="text" name="weight_{{ entry.competitor_id }}" class="form-control" value="{{ entry.check.result if entry.check else '' }}"></td>
                            {% elif check_type == 'ecu' %}
                                <td><input type="text" name="ecu_number_{{ entry.competitor_id }}" class="form-control" value="{{ entry.check.ecu_number if entry.check else '' }}"></td>
                                <td><input type="text" name="ecu_tune_{{ entry.competitor_id }}" class="form-control" value="{{ entry.check.ecu_tune if entry.check else '' }}"></td>
                            {% elif check_type == 'engine' %}
                                <td><input type="text" name="engine_number_{{ entry.competitor_id }}" class="form-control" value="{{ entry.check.engine_number if entry.check else '' }}"></td>
                            {% elif check_type == 'other' %}
                                <td>
                                    <input type="text" name="other_status_{{ entry.competitor_id }}" class="form-control" value="{{ entry.check.status if entry.check else '' }}">
                                </td>
                            {% else %}
                                <td>
                                    <select name="{{ check_type }}_status_{{ entry.competitor_id }}" class="form-select">
                                        <option value="" {% if not entry.check or not entry.check.result %}selected{% endif %}>-- Select --</option>
                                        <option value="Pass" {% if entry.check and entry.check.result == 'Pass' %}selected{% endif %}>Pass</option>
                                        <option value="Fail" {% if entry.check and entry.check.result == 'Fail' %}selected{% endif %}>Fail</option>
                                        <option value="Pending" {% if entry.check and entry.check.result == 'Pending' %}selected{% endif %}>Pending</option>
                                    </select>
                                </td>
                            {% endif %}
                            
                            <td>
                                <textarea name="notes_{{ entry.competitor_id }}" class="form-control" rows="2">{{ entry.check.notes if entry.check else '' }}</textarea>
                            </td>
                            <td>
                                <button type="submit" class="btn btn-sm btn-primary" 
                                        formaction="{{ url_for('save_technical_check', event_id=event.id) }}"
                                        name="competitor_id" value="{{ entry.competitor_id }}"
                                        onclick="prepareOtherCheckSave(this)">Save</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <div class="d-flex justify-content-end mt-3 mb-4">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="bi bi-save"></i> Save All Changes
                    </button>
                </div>
            </form>
        </div>
        
        <div class="mb-4 mt-4 text-end">
            <a href="{{ url_for('formula_ford_dashboard') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Formula Ford Dashboard
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Function to ensure the 'other_check_name' is included in single-save submissions
        function prepareOtherCheckSave(button) {
            if ('{{ check_type }}' === 'other') {
                const form = button.closest('form');
                // The 'other_check_name' is already part of the main form, so clicking the button with formaction will include it.
                // This function is a placeholder for any future logic but also serves as a good reminder of the process.
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            {% if check_type == 'other' %}
                // Load previous "other check" names via API
                fetch('{{ url_for("get_other_check_names", event_id=event.id) }}')
                    .then(response => response.json())
                    .then(data => {
                        const dropdown = document.getElementById('previous-checks-dropdown');
                        dropdown.innerHTML = '';
                        
                        if (data.check_names && data.check_names.length > 0) {
                            // Add each check name to the dropdown
                            data.check_names.forEach(name => {
                                const item = document.createElement('li');
                                const link = document.createElement('a');
                                link.classList.add('dropdown-item');
                                link.href = '#';
                                link.textContent = name;
                                link.href = `{{ url_for('technical_check', event_id=event.id, check_type='other') }}&other_check_name=${encodeURIComponent(name)}`;
                                link.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    window.location.href = this.href;
                                });
                                item.appendChild(link);
                                dropdown.appendChild(item);
                            });
                        } else {
                            // No previous check names
                            const item = document.createElement('li');
                            const link = document.createElement('a');
                            link.classList.add('dropdown-item');
                            link.href = '#';
                            link.textContent = 'No previous checks found';
                            item.appendChild(link);
                            dropdown.appendChild(item);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching previous check names:', error);
                        const dropdown = document.getElementById('previous-checks-dropdown');
                        dropdown.innerHTML = '<li><a class="dropdown-item" href="#">Error loading checks</a></li>';
                    });
            {% endif %}
        });
    </script>

    <datalist id="previous_check_names"></datalist>
</body>
</html> 