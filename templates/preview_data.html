<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview Import Data</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .excluded {
            opacity: 0.5;
            background-color: #f8f8f8;
        }
        input[type="text"], select {
            width: 100%;
            padding: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <header>
        <h1>Preview Import Data</h1>
    </header>

    <section>
        <h2>Review Data Before Import</h2>
        
        <button type="button" onclick="toggleMakeModel()">Toggle Make/Model Split</button>
        
        <form method="POST" action="{{ url_for('import_data') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <table>
                <thead>
                    <tr>
                        <th>Vehicle #</th>
                        <th>Driver</th>
                        <th>Make</th>
                        <th>Model</th>
                        <th>Class</th>
                        <th>Team</th>
                        <th>Garage</th>
                        <th>Log Book #</th>
                        <th>License #</th>
                        <th>Exclude</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in rows %}
                    <tr class="{% if row.should_exclude %}excluded{% endif %}">
                        <td><input type="text" name="vehicle_number[]" value="{{ row.get('vehicle_number', '') }}"></td>
                        <td><input type="text" name="driver_name[]" value="{{ row.get('driver_name', '') }}"></td>
                        <td><input type="text" name="vehicle_make[]" value="{{ row.get('vehicle_make', '') }}" 
                                 data-original-value="{{ row.get('vehicle_make', '') }}"></td>
                        <td><input type="text" name="vehicle_model[]" value="{{ row.get('vehicle_model', '') }}"
                                 data-original-value="{{ row.get('vehicle_model', '') }}"></td>
                        <td>
                            <select name="class_type[]">
                                {% for class_type in valid_classes %}
                                <option value="{{ class_type }}" {% if class_type == row.get('class_type', '') %}selected{% endif %}>
                                    {{ class_type }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td><input type="text" name="team_name[]" value="{{ row.get('team_name', '') }}"></td>
                        <td><input type="text" name="garage_number[]" value="{{ row.get('garage_number', '') }}"></td>
                        <td><input type="text" name="log_book_number[]" value="{{ row.get('log_book_number', '') }}"></td>
                        <td><input type="text" name="licence_number[]" value="{{ row.get('licence_number', '') }}"></td>
                        <td>
                            <input type="checkbox" name="exclude[]" value="true" 
                                   {% if row.should_exclude %}checked{% endif %}>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div class="button-group">
                <button type="submit">Import Data</button>
                <button type="button" onclick="window.location.href='{{ url_for('import_entries') }}'">Back</button>
            </div>
        </form>
    </section>

    <script>
        function toggleMakeModel() {
            const rows = document.querySelectorAll('tbody tr');
            const button = document.querySelector('button');
            
            rows.forEach(row => {
                const makeInput = row.querySelector('input[name="vehicle_make[]"]');
                const modelInput = row.querySelector('input[name="vehicle_model[]"]');
                
                if (button.textContent === 'Toggle Make/Model Split') {
                    // Split mode
                    const combined = makeInput.value + ' ' + modelInput.value;
                    const parts = combined.trim().split(/\s+/);
                    
                    if (parts.length > 1) {
                        makeInput.value = parts[0];
                        modelInput.value = parts.slice(1).join(' ');
                    }
                } else {
                    // Combine mode
                    makeInput.value = makeInput.getAttribute('data-original-value');
                    modelInput.value = modelInput.getAttribute('data-original-value');
                }
            });
            
            button.textContent = button.textContent === 'Toggle Make/Model Split' 
                ? 'Restore Original' 
                : 'Toggle Make/Model Split';
        }

        // Handle row exclusion
        document.querySelectorAll('input[name="exclude[]"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const row = this.closest('tr');
                if (this.checked) {
                    row.classList.add('excluded');
                } else {
                    row.classList.remove('excluded');
                }
            });
        });
    </script>
</body>
</html>